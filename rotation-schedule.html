<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a7ea4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Î°úÌÖåÏù¥ÏÖò ÏùºÏ†ï">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Î≥∏Í≥º 3ÌïôÎÖÑ Î°úÌÖåÏù¥ÏÖò ÏùºÏ†ï Í¥ÄÎ¶¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --primary: #0a7ea4;
            --primary-dark: #065a75;
            --secondary: #34d399;
            --accent: #f59e0b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(15, 23, 42, 0.08);
            --shadow-lg: rgba(15, 23, 42, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: var(--bg-card);
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            margin-bottom: 30px;
            border-left: 6px solid var(--primary);
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .calendar-section {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            position: sticky;
            top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .calendar-header h2 {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: var(--bg-main);
        }
        
        .calendar-day:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        
        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }
        
        .calendar-day.empty:hover {
            transform: none;
        }
        
        .calendar-day.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(10, 126, 164, 0.3);
        }
        
        .calendar-day.has-schedule {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            font-weight: 600;
        }
        
        .calendar-day.has-exam {
            position: relative;
        }
        
        .calendar-day.has-exam::after {
            content: attr(data-exam-icon);
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
        }
        
        .calendar-day[data-subject-color] {
            position: relative;
            font-weight: 600;
        }
        
        .calendar-day[data-subject-color]::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 0 0 10px 10px;
            background: attr(data-subject-color);
        }
        
        .exam-toggle {
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .exam-toggle:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }
        
        .exam-toggle.active {
            background: #fef3c7;
            border-color: #fbbf24;
        }
        
        .subject-manager {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .manage-subjects-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .manage-subjects-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10, 126, 164, 0.3);
        }
        
        .subject-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .subject-modal.show {
            display: flex;
        }
        
        .subject-modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .subject-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid var(--border);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .subject-modal-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }
        
        .subject-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .subject-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .subject-modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .subject-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-item {
            background: white;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .subject-color-picker {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 3px solid #e5e7eb;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .subject-color-picker:hover {
            transform: scale(1.1);
            border-color: #9ca3af;
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            margin-top: 8px;
            width: 100%;
        }
        
        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.15);
            border-color: #374151;
        }
        
        .color-option.selected {
            border-color: #374151;
            border-width: 3px;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #374151;
        }
        
        .subject-input, .date-input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .subject-input {
            flex: 1;
            min-width: 120px;
        }
        
        .date-input {
            width: 110px;
        }
        
        .remove-subject-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .add-subject-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        
        .add-subject-btn:hover {
            background: #10b981;
        }
        
        .schedule-section {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            min-height: 600px;
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .schedule-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .btn-export {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(10, 126, 164, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(10, 126, 164, 0.3);
        }
        
        .btn-export:active {
            transform: translateY(0);
        }
        
        .teams-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .team-schedule {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .team-schedule:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 24px var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }
        
        .team-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .add-schedule-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-schedule-btn:hover {
            background: #10b981;
            transform: scale(1.05);
        }
        
        .schedule-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .time-input, .location-input {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
            background: white;
        }
        
        .time-input {
            width: 100px;
            font-weight: 500;
        }
        
        .location-input {
            flex: 1;
        }
        
        .time-input:focus, .location-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 126, 164, 0.1);
        }
        
        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .notes-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
        }
        
        .notes-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notes-section h3::before {
            content: "üìå";
            font-size: 18px;
        }
        
        .notes-textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Noto Sans KR', sans-serif;
            resize: vertical;
            min-height: 100px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .empty-state p {
            font-size: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .modal.show {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: var(--bg-main);
            color: var(--text-primary);
        }
        
        .export-message {
            background: var(--bg-main);
            padding: 20px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.8;
            white-space: pre-wrap;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }
        
        .copy-btn {
            width: 100%;
            margin-top: 20px;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover {
            background: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 211, 153, 0.3);
        }
        
        .copy-btn.copied {
            background: var(--primary);
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .calendar-section {
                position: relative;
                top: 0;
            }
            
            .teams-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Î≥∏Í≥º 3ÌïôÎÖÑ Î°úÌÖåÏù¥ÏÖò ÏùºÏ†ï Í¥ÄÎ¶¨</h1>
            <p class="subtitle">4Í∞ú Ï°∞ ÌÜµÌï© Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</p>
        </header>
        
        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 id="calendarTitle">2026ÎÖÑ 3Ïõî</h2>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="changeMonth(-1)" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">‚Äπ</button>
                        <button onclick="changeMonth(1)" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
                
                <div class="subject-manager" style="margin-top: 25px;">
                    <button class="manage-subjects-btn" onclick="openSubjectModal()">
                        ‚öôÔ∏è Í≥º Í¥ÄÎ¶¨
                    </button>
                    <button class="manage-subjects-btn" onclick="openMembersModal()" style="margin-top: 10px; background: var(--secondary);">
                        üë• Ï°∞Ïõê Í¥ÄÎ¶¨
                    </button>
                    <button class="manage-subjects-btn" onclick="openDashboard()" style="margin-top: 10px; background: #f59e0b;">
                        üìä ÌÜµÍ≥Ñ
                    </button>
                </div>
            </div>
            
            <div class="schedule-section">
                <div id="scheduleContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</h3>
                        <p>ÏôºÏ™Ω Îã¨Î†•ÏóêÏÑú ÏùºÏ†ïÏùÑ Í¥ÄÎ¶¨Ìï† ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ ÏùºÏ†ï ÎÇ¥Î≥¥ÎÇ¥Í∏∞</h3>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <div class="export-message" id="exportMessage"></div>
            <button class="copy-btn" onclick="copyToClipboard()">ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨</button>
        </div>
    </div>
    
    <div class="subject-modal" id="subjectModal">
        <div class="subject-modal-content">
            <div class="subject-modal-header">
                <h2>üìö Í≥º Îã®ÏúÑ Í∏∞Í∞Ñ ÏÑ§Ï†ï</h2>
                <button class="subject-modal-close" onclick="closeSubjectModal()">√ó</button>
            </div>
            <div class="subject-modal-body">
                <div class="subject-list" id="subjectList">
                    <!-- Subject items will be rendered here -->
                </div>
                <button class="add-subject-btn" onclick="addSubject()">+ Í≥º Ï∂îÍ∞Ä</button>
            </div>
        </div>
    </div>
    
    <div class="subject-modal" id="membersModal">
        <div class="subject-modal-content">
            <div class="subject-modal-header" style="background: linear-gradient(135deg, var(--secondary) 0%, #10b981 100%);">
                <h2>üë• Ï°∞Ïõê Î™ÖÎã® Í¥ÄÎ¶¨</h2>
                <button class="subject-modal-close" onclick="closeMembersModal()">√ó</button>
            </div>
            <div class="subject-modal-body">
                <div id="membersContent">
                    <!-- Members will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="subject-modal" id="weeklyModal">
        <div class="subject-modal-content" style="max-width: 95%; max-height: 95vh;">
            <div class="subject-modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <h2>üìÖ Ï£ºÍ∞Ñ ÏãúÍ∞ÑÌëú</h2>
                <button class="subject-modal-close" onclick="closeWeeklyView()">√ó</button>
            </div>
            <div class="subject-modal-body" style="padding: 20px; overflow: auto;">
                <div id="weeklyContent">
                    <!-- Weekly timetable will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="subject-modal" id="dashboardModal">
        <div class="subject-modal-content" style="max-width: 900px;">
            <div class="subject-modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h2>üìä ÌÜµÍ≥Ñ ÎåÄÏãúÎ≥¥Îìú</h2>
                <button class="subject-modal-close" onclick="closeDashboard()">√ó</button>
            </div>
            <div class="subject-modal-body" style="padding: 30px; overflow: auto;">
                <div id="dashboardContent">
                    <!-- Dashboard will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="subject-modal" id="templateModal">
        <div class="subject-modal-content">
            <div class="subject-modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                <h2>üìã ÌÖúÌîåÎ¶ø Í¥ÄÎ¶¨</h2>
                <button class="subject-modal-close" onclick="closeTemplateModal()">√ó</button>
            </div>
            <div class="subject-modal-body">
                <div id="templateContent">
                    <!-- Template management will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="subject-modal" id="examTypeModal">
        <div class="subject-modal-content" style="max-width: 500px;">
            <div class="subject-modal-header" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                <h2>‚≠ê ÌèâÍ∞Ä Ïú†Ìòï ÏÑ†ÌÉù</h2>
                <button class="subject-modal-close" onclick="closeExamTypeModal()">√ó</button>
            </div>
            <div class="subject-modal-body" style="padding: 25px;">
                <div id="examTypeContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Data structure to store schedules
        let scheduleData = {};
        let selectedDate = null;
        let currentYear = 2026;
        let currentMonth = 3; // March (1-based)
        let subjects = []; // Array of {name, color, startDate, endDate}
        let examDates = {}; // Exam dates with types: {date: {type, label, color, icon}}
        let showingColorPicker = null; // Track which subject is showing color picker
        let teamMembers = {
            '1Ï°∞': [],
            '2Ï°∞': [],
            '3Ï°∞': [],
            '4Ï°∞': []
        }; // Team members: {teamName: [{name, phone}]}
        let templates = []; // Saved templates: [{name, data}]
        
        // Month data for 2026
        const monthData = {
            3: { name: '3Ïõî', firstDay: 0, days: 31 },  // March 1, 2026 is Sunday
            4: { name: '4Ïõî', firstDay: 3, days: 30 },  // April 1, 2026 is Wednesday
            5: { name: '5Ïõî', firstDay: 5, days: 31 },  // May 1, 2026 is Friday
            6: { name: '6Ïõî', firstDay: 1, days: 30 },  // June 1, 2026 is Monday
            7: { name: '7Ïõî', firstDay: 3, days: 31 },  // July 1, 2026 is Wednesday
            8: { name: '8Ïõî', firstDay: 6, days: 31 },  // August 1, 2026 is Saturday
            9: { name: '9Ïõî', firstDay: 2, days: 30 },  // September 1, 2026 is Tuesday
            10: { name: '10Ïõî', firstDay: 4, days: 31 }, // October 1, 2026 is Thursday
            11: { name: '11Ïõî', firstDay: 0, days: 30 }, // November 1, 2026 is Sunday
            12: { name: '12Ïõî', firstDay: 2, days: 31 }  // December 1, 2026 is Tuesday
        };
        
        // 20 color palette
        const colorPalette = [
            '#ef4444', // Îπ®Í∞ï
            '#f97316', // Ï£ºÌô©
            '#f59e0b', // ÎÖ∏Îûë-Ï£ºÌô©
            '#eab308', // ÎÖ∏Îûë
            '#84cc16', // Ïó∞Îëê
            '#22c55e', // Ï¥àÎ°ù
            '#10b981', // Ï≤≠Î°ù
            '#14b8a6', // ÌÑ∞ÏΩ∞Ïù¥Ï¶à
            '#06b6d4', // ÌïòÎäò
            '#0ea5e9', // ÌååÎûë
            '#3b82f6', // ÏßÑÌååÎûë
            '#6366f1', // Ïù∏ÎîîÍ≥†
            '#8b5cf6', // Î≥¥Îùº
            '#a855f7', // ÏûêÏ£º
            '#d946ef', // ÎßàÏ††ÌÉÄ
            '#ec4899', // ÌïëÌÅ¨
            '#f43f5e', // Î°úÏ¶à
            '#64748b', // ÌöåÏÉâ
            '#78716c', // Í∞àÏÉâ
            '#57534e'  // ÏßÑÍ∞àÏÉâ
        ];
        
        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('rotationScheduleData');
            if (saved) {
                try {
                    scheduleData = JSON.parse(saved);
                } catch (e) {
                    scheduleData = {};
                }
            }
            
            const savedSubjects = localStorage.getItem('rotationSubjects');
            if (savedSubjects) {
                try {
                    subjects = JSON.parse(savedSubjects);
                } catch (e) {
                    subjects = [];
                }
            }
            
            const savedExams = localStorage.getItem('rotationExams');
            if (savedExams) {
                try {
                    const parsed = JSON.parse(savedExams);
                    // Í∏∞Ï°¥ Set Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                    if (Array.isArray(parsed)) {
                        examDates = {};
                        parsed.forEach(date => {
                            examDates[date] = { type: 'exam', label: 'ÏãúÌóò', color: '#fbbf24', icon: '‚≠ê' };
                        });
                    } else {
                        examDates = parsed;
                    }
                } catch (e) {
                    examDates = {};
                }
            }
            
            const savedMembers = localStorage.getItem('rotationTeamMembers');
            if (savedMembers) {
                try {
                    teamMembers = JSON.parse(savedMembers);
                } catch (e) {
                    teamMembers = { '1Ï°∞': [], '2Ï°∞': [], '3Ï°∞': [], '4Ï°∞': [] };
                }
            }
            
            const savedTemplates = localStorage.getItem('rotationTemplates');
            if (savedTemplates) {
                try {
                    templates = JSON.parse(savedTemplates);
                } catch (e) {
                    templates = [];
                }
            }
        }
        
        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('rotationScheduleData', JSON.stringify(scheduleData));
                localStorage.setItem('rotationSubjects', JSON.stringify(subjects));
                localStorage.setItem('rotationExams', JSON.stringify(examDates));
                localStorage.setItem('rotationTeamMembers', JSON.stringify(teamMembers));
                localStorage.setItem('rotationTemplates', JSON.stringify(templates));
            } catch (e) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
            }
        }
        
        // Get subject for a specific date
        function getSubjectForDate(dateStr) {
            for (let subject of subjects) {
                if (dateStr >= subject.startDate && dateStr <= subject.endDate) {
                    return subject;
                }
            }
            return null;
        }
        
        // Initialize calendar
        function initCalendar() {
            const calendar = document.getElementById('calendar');
            const daysOfWeek = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            
            calendar.innerHTML = '';
            
            daysOfWeek.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            const monthInfo = monthData[currentMonth];
            const firstDay = monthInfo.firstDay;
            const daysInMonth = monthInfo.days;
            
            document.getElementById('calendarTitle').textContent = `2026ÎÖÑ ${monthInfo.name}`;
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendar.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                const dateStr = `2026-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateStr;
                
                // Add subject color
                const subject = getSubjectForDate(dateStr);
                if (subject) {
                    dayCell.style.setProperty('--subject-color', subject.color);
                    dayCell.setAttribute('data-subject-color', subject.color);
                }
                
                // Add exam marker
                if (examDates[dateStr]) {
                    const examInfo = examDates[dateStr];
                    dayCell.classList.add('has-exam');
                    dayCell.setAttribute('data-exam-color', examInfo.color);
                    dayCell.setAttribute('data-exam-icon', examInfo.icon);
                }
                
                dayCell.onclick = () => selectDate(dateStr);
                calendar.appendChild(dayCell);
            }
            
            // Apply subject color via style element
            const style = document.createElement('style');
            style.textContent = subjects.map((subject, index) => 
                `.calendar-day[data-subject-color="${subject.color}"]::before { background: ${subject.color}; }`
            ).join('\n');
            
            const oldStyle = document.getElementById('dynamic-subject-styles');
            if (oldStyle) oldStyle.remove();
            style.id = 'dynamic-subject-styles';
            document.head.appendChild(style);
            
            updateCalendarIndicators();
        }
        
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 3) currentMonth = 3;
            if (currentMonth > 12) currentMonth = 12;
            selectedDate = null;
            initCalendar();
            document.getElementById('scheduleContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <h3>ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</h3>
                    <p>ÏôºÏ™Ω Îã¨Î†•ÏóêÏÑú ÏùºÏ†ïÏùÑ Í¥ÄÎ¶¨Ìï† ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                </div>
            `;
        }
        
        function toggleExam() {
            if (!selectedDate) return;
            document.getElementById('examTypeModal').classList.add('show');
            renderExamTypeModal();
        }
        
        function closeExamTypeModal() {
            document.getElementById('examTypeModal').classList.remove('show');
        }
        
        const examTypes = [
            { type: 'exam', label: 'ÏãúÌóò', color: '#fbbf24', icon: '‚≠ê' },
            { type: 'case', label: 'ÏºÄÏù¥Ïä§ Î∞úÌëú', color: '#3b82f6', icon: 'üìã' },
            { type: 'outpatient', label: 'Ïô∏Îûò Ï¥àÏßÑ', color: '#22c55e', icon: 'üè•' },
            { type: 'report', label: 'Î≥¥Í≥†ÏÑú Ï†úÏ∂ú', color: '#f97316', icon: 'üìÑ' },
            { type: 'other', label: 'Í∏∞ÌÉÄ', color: '#6b7280', icon: 'üìå' }
        ];
        
        function renderExamTypeModal() {
            const container = document.getElementById('examTypeContent');
            if (!container || !selectedDate) return;
            
            const currentExam = examDates[selectedDate];
            
            let html = `
                <p style="color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                    Ïù¥ ÎÇ†ÏßúÏóê Ïñ¥Îñ§ ÌèâÍ∞ÄÍ∞Ä ÏûàÎÇòÏöî?
                </p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
            `;
            
            examTypes.forEach(examType => {
                const isSelected = currentExam && currentExam.type === examType.type;
                html += `
                    <button
                        onclick="setExamType('${examType.type}')"
                        style="
                            padding: 18px 20px;
                            border: 3px solid ${isSelected ? examType.color : 'var(--border)'};
                            background: ${isSelected ? examType.color + '20' : 'white'};
                            border-radius: 12px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            font-size: 16px;
                            font-weight: ${isSelected ? '700' : '600'};
                            color: var(--text-primary);
                            transition: all 0.2s ease;
                            font-family: 'Noto Sans KR', sans-serif;
                        "
                        onmouseover="this.style.borderColor='${examType.color}'; this.style.background='${examType.color}10';"
                        onmouseout="this.style.borderColor='${isSelected ? examType.color : 'var(--border)'}'; this.style.background='${isSelected ? examType.color + '20' : 'white'}';"
                    >
                        <span style="font-size: 28px;">${examType.icon}</span>
                        <span style="flex: 1; text-align: left;">${examType.label}</span>
                        ${isSelected ? '<span style="color: ' + examType.color + '; font-size: 20px;">‚úì</span>' : ''}
                    </button>
                `;
            });
            
            html += '</div>';
            
            if (currentExam) {
                html += `
                    <button
                        onclick="removeExam()"
                        style="
                            width: 100%;
                            padding: 14px;
                            margin-top: 20px;
                            border: 2px solid #ef4444;
                            background: white;
                            color: #ef4444;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 15px;
                            font-weight: 600;
                            font-family: 'Noto Sans KR', sans-serif;
                        "
                    >
                        ‚úï ÌèâÍ∞Ä Ï†úÍ±∞
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function setExamType(type) {
            const examType = examTypes.find(t => t.type === type);
            if (!examType) return;
            
            examDates[selectedDate] = { ...examType };
            saveData();
            initCalendar();
            renderSchedule();
            closeExamTypeModal();
        }
        
        function removeExam() {
            delete examDates[selectedDate];
            saveData();
            initCalendar();
            renderSchedule();
            closeExamTypeModal();
        }
        
        function selectDate(date) {
            selectedDate = date;
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
                if (day.dataset.date === date) {
                    day.classList.add('selected');
                }
            });
            
            if (!scheduleData[date]) {
                scheduleData[date] = {
                    teams: ['1Ï°∞'],
                    teamSchedules: { '1Ï°∞': [] },
                    notes: ''
                };
                saveData();
            }
            renderSchedule();
        }
        
        function addTeam() {
            if (!selectedDate) return;
            const data = scheduleData[selectedDate];
            const teamCount = data.teams.length;
            const newTeamName = `${teamCount + 1}Ï°∞`;
            data.teams.push(newTeamName);
            data.teamSchedules[newTeamName] = [];
            saveData();
            renderSchedule();
        }
        
        function removeTeam(teamName) {
            if (!selectedDate) return;
            const data = scheduleData[selectedDate];
            if (data.teams.length <= 1) {
                alert('ÏµúÏÜå 1Í∞úÏùò Ï°∞Îäî ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§!');
                return;
            }
            data.teams = data.teams.filter(t => t !== teamName);
            delete data.teamSchedules[teamName];
            saveData();
            renderSchedule();
        }
        
        function renderSchedule() {
            if (!selectedDate) return;
            const data = scheduleData[selectedDate];
            const dateObj = new Date(selectedDate);
            const dateStr = `${dateObj.getMonth() + 1}Ïõî ${dateObj.getDate()}Ïùº`;
            const examInfo = examDates[selectedDate];
            
            const examButtonLabel = examInfo ? `${examInfo.icon} ${examInfo.label}` : '‚òÜ ÌèâÍ∞Ä';
            const examButtonStyle = examInfo ? `background: ${examInfo.color}30; border-color: ${examInfo.color};` : '';
            
            const content = `
                <div class="schedule-header">
                    <h2>${dateStr} ÏùºÏ†ï</h2>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button class="add-schedule-btn" onclick="toggleExam()" style="padding: 10px 18px; ${examButtonStyle}">
                            ${examButtonLabel}
                        </button>
                        <button class="add-schedule-btn" onclick="openWeeklyView()" style="padding: 10px 18px; background: #8b5cf6;">üìÖ Ï£ºÍ∞ÑÌëú</button>
                        <button class="add-schedule-btn" onclick="openTemplateModal()" style="padding: 10px 18px; background: #ec4899;">üìã ÌÖúÌîåÎ¶ø</button>
                        <button class="add-schedule-btn" onclick="addTeam()" style="padding: 10px 18px;">‚ûï Ï°∞ Ï∂îÍ∞Ä</button>
                        <button class="add-schedule-btn" onclick="exportSchedule()" style="padding: 10px 18px; background: var(--primary);">üì§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                    </div>
                </div>
                
                <div class="teams-container">
                    ${data.teams.map(team => `
                        <div class="team-schedule">
                            <div class="team-header">
                                <span class="team-name">${team}</span>
                                <div style="display: flex; gap: 6px;">
                                    <button class="add-schedule-btn" onclick="addScheduleItem('${team}')">+ Ï∂îÍ∞Ä</button>
                                    ${data.teams.length > 1 ? `<button class="remove-btn" onclick="removeTeam('${team}')" style="padding: 6px 12px;">üóëÔ∏è Ï°∞ ÏÇ≠Ï†ú</button>` : ''}
                                </div>
                            </div>
                            <div id="team-${team}">${renderTeamSchedules(team)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="notes-section">
                    <h3>Ï∞∏Í≥†ÏÇ¨Ìï≠</h3>
                    <textarea class="notes-textarea" placeholder="Ï∂îÍ∞ÄÎ°ú Í≥µÏßÄÌï† ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onchange="updateNotes(this.value)">${data.notes}</textarea>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">üìé Ï≤®Î∂Ä Ïù¥ÎØ∏ÏßÄ</h4>
                        <input 
                            type="file" 
                            id="imageInput" 
                            accept="image/*" 
                            multiple
                            style="display: none;"
                            onchange="handleImageUpload(event)"
                        />
                        <button 
                            class="add-schedule-btn" 
                            onclick="document.getElementById('imageInput').click()"
                            style="width: 100%; margin-bottom: 15px;">
                            üì∑ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
                        </button>
                        <div id="imagePreviewContainer"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('scheduleContent').innerHTML = content;
            updateCalendarIndicators();
            renderImagePreviews(); // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Î†åÎçîÎßÅ
        }
        
        function renderTeamSchedules(team) {
            const schedules = scheduleData[selectedDate].teamSchedules[team];
            if (schedules.length === 0) {
                return '<p style="color: var(--text-secondary); font-size: 14px; padding: 10px 0;">ÏùºÏ†ïÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>';
            }
            return schedules.map((item, index) => {
                // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò (time -> startTime, endTime)
                if (item.time && !item.startTime) {
                    item.startTime = item.time;
                    item.endTime = '';
                }
                
                return `
                <div class="schedule-item" style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap;">
                    <input 
                        type="time" 
                        class="time-input" 
                        value="${item.startTime || ''}" 
                        onchange="updateScheduleItem('${team}', ${index}, 'startTime', this.value)"
                        style="width: 90px; padding: 10px 8px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; font-family: 'JetBrains Mono', monospace; font-weight: 500;"
                    />
                    <span style="color: var(--text-secondary); font-weight: 600;">~</span>
                    <input 
                        type="time" 
                        class="time-input" 
                        value="${item.endTime || ''}" 
                        onchange="updateScheduleItem('${team}', ${index}, 'endTime', this.value)"
                        style="width: 90px; padding: 10px 8px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; font-family: 'JetBrains Mono', monospace; font-weight: 500;"
                    />
                    <input 
                        type="text" 
                        class="location-input" 
                        placeholder="Ïã§Ïäµ Ïû•ÏÜå ÏûÖÎ†•" 
                        value="${item.location}" 
                        onchange="updateScheduleItem('${team}', ${index}, 'location', this.value)"
                        style="flex: 1; min-width: 150px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px;"
                    />
                    <button 
                        class="remove-btn" 
                        onclick="removeScheduleItem('${team}', ${index})"
                        style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">ÏÇ≠Ï†ú</button>
                </div>
            `;
            }).join('');
        }
        
        function addScheduleItem(team) {
            scheduleData[selectedDate].teamSchedules[team].push({ 
                startTime: '', 
                endTime: '', 
                location: '' 
            });
            saveData();
            renderSchedule();
        }
        
        function removeScheduleItem(team, index) {
            scheduleData[selectedDate].teamSchedules[team].splice(index, 1);
            saveData();
            renderSchedule();
        }
        
        function updateScheduleItem(team, index, field, value) {
            scheduleData[selectedDate].teamSchedules[team][index][field] = value;
            saveData();
            updateCalendarIndicators();
        }
        
        function updateNotes(value) {
            scheduleData[selectedDate].notes = value;
            saveData();
        }
        
        // Image attachment functions
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            if (!scheduleData[selectedDate].images) {
                scheduleData[selectedDate].images = [];
            }
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        scheduleData[selectedDate].images.push({
                            data: e.target.result,
                            name: file.name,
                            type: file.type,
                            uploadedAt: new Date().toISOString()
                        });
                        saveData();
                        renderImagePreviews();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
            event.target.value = '';
        }
        
        function removeImage(index) {
            if (!confirm('Ïù¥ Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            scheduleData[selectedDate].images.splice(index, 1);
            saveData();
            renderImagePreviews();
        }
        
        function renderImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            if (!container || !selectedDate) return;
            
            const images = scheduleData[selectedDate].images || [];
            
            if (images.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 20px;">Ï≤®Î∂ÄÎêú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">';
            
            images.forEach((img, index) => {
                html += `
                    <div style="position: relative; border: 2px solid var(--border); border-radius: 10px; overflow: hidden; background: var(--bg-main);">
                        <img 
                            src="${img.data}" 
                            alt="${img.name}"
                            onclick="viewImageFullscreen('${img.data}', '${img.name}')"
                            style="width: 100%; height: 150px; object-fit: cover; cursor: pointer; display: block;"
                        />
                        <div style="padding: 8px; background: white;">
                            <div style="font-size: 12px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${img.name}">${img.name}</div>
                        </div>
                        <button 
                            onclick="removeImage(${index})"
                            style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            √ó
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function viewImageFullscreen(dataUrl, name) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.onclick = () => modal.remove();
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px;';
            img.onclick = (e) => e.stopPropagation();
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: white; color: black; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; font-weight: bold;';
            closeBtn.onclick = () => modal.remove();
            
            modal.appendChild(img);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);
        }
        
        function updateCalendarIndicators() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                if (day.dataset.date && scheduleData[day.dataset.date]) {
                    const data = scheduleData[day.dataset.date];
                    const hasSchedules = data.teams.some(team => 
                        data.teamSchedules[team] && data.teamSchedules[team].length > 0
                    );
                    if (hasSchedules) {
                        day.classList.add('has-schedule');
                    } else {
                        day.classList.remove('has-schedule');
                    }
                }
            });
        }
        
        function addSubject() {
            subjects.push({ name: '', color: colorPalette[0], startDate: '', endDate: '' });
            saveData();
            renderSubjectList();
        }
        
        function removeSubject(index) {
            subjects.splice(index, 1);
            saveData();
            initCalendar();
            renderSubjectList();
        }
        
        function updateSubject(index, field, value) {
            subjects[index][field] = value;
            saveData();
            if (field === 'color' || field === 'startDate' || field === 'endDate') {
                initCalendar();
            }
        }
        
        function toggleColorPicker(index) {
            showingColorPicker = showingColorPicker === index ? null : index;
            renderSubjectList();
        }
        
        function openSubjectModal() {
            document.getElementById('subjectModal').classList.add('show');
            renderSubjectList();
        }
        
        function closeSubjectModal() {
            document.getElementById('subjectModal').classList.remove('show');
            showingColorPicker = null;
        }
        
        // Team members management
        function openMembersModal() {
            document.getElementById('membersModal').classList.add('show');
            renderMembersList();
        }
        
        function closeMembersModal() {
            document.getElementById('membersModal').classList.remove('show');
        }
        
        // Weekly timetable view
        function openWeeklyView() {
            if (!selectedDate) return;
            document.getElementById('weeklyModal').classList.add('show');
            renderWeeklyTimetable();
        }
        
        function closeWeeklyView() {
            document.getElementById('weeklyModal').classList.remove('show');
        }
        
        // Dashboard functions
        function openDashboard() {
            document.getElementById('dashboardModal').classList.add('show');
            renderDashboard();
        }
        
        function closeDashboard() {
            document.getElementById('dashboardModal').classList.remove('show');
        }
        
        // Template management functions
        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('show');
            renderTemplateModal();
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('show');
        }
        
        function saveAsTemplate() {
            if (!selectedDate) {
                alert('ÎÇ†ÏßúÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const data = scheduleData[selectedDate];
            if (!data || !data.teams || data.teams.length === 0) {
                alert('Ï†ÄÏû•Ìï† ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            
            const templateName = prompt('ÌÖúÌîåÎ¶ø Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', 'ÏõîÏöîÏùº Í∏∞Î≥∏ ÏùºÏ†ï');
            if (!templateName) return;
            
            // Îî• Ïπ¥Ìîº
            const templateData = JSON.parse(JSON.stringify({
                teams: data.teams,
                teamSchedules: data.teamSchedules,
                notes: data.notes
            }));
            
            templates.push({
                name: templateName,
                data: templateData,
                createdAt: new Date().toISOString()
            });
            
            saveData();
            alert('‚úÖ ÌÖúÌîåÎ¶øÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
            renderTemplateModal();
        }
        
        function applyTemplate(index) {
            if (!selectedDate) {
                alert('ÎÇ†ÏßúÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            if (!confirm('ÌòÑÏû¨ ÏùºÏ†ïÏùÑ ÌÖúÌîåÎ¶øÏúºÎ°ú ÎçÆÏñ¥Ïì∞ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            const template = templates[index];
            const templateData = JSON.parse(JSON.stringify(template.data));
            
            scheduleData[selectedDate] = templateData;
            saveData();
            renderSchedule();
            closeTemplateModal();
            alert('‚úÖ ÌÖúÌîåÎ¶øÏù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!');
        }
        
        function deleteTemplate(index) {
            if (!confirm('Ïù¥ ÌÖúÌîåÎ¶øÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            templates.splice(index, 1);
            saveData();
            renderTemplateModal();
        }
        
        function renderTemplateModal() {
            const container = document.getElementById('templateContent');
            if (!container) return;
            
            let html = `
                <div style="margin-bottom: 25px;">
                    <button 
                        class="add-subject-btn" 
                        onclick="saveAsTemplate()"
                        style="background: #ec4899; margin-bottom: 10px;">
                        üíæ ÌòÑÏû¨ ÏùºÏ†ïÏùÑ ÌÖúÌîåÎ¶øÏúºÎ°ú Ï†ÄÏû•
                    </button>
                    <p style="color: var(--text-secondary); font-size: 14px; text-align: center;">
                        ÌòÑÏû¨ ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÏùò ÏùºÏ†ïÏù¥ ÌÖúÌîåÎ¶øÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§
                    </p>
                </div>
                
                <div style="border-top: 2px solid var(--border); padding-top: 25px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 20px;">üìã Ï†ÄÏû•Îêú ÌÖúÌîåÎ¶ø (${templates.length}Í∞ú)</h3>
            `;
            
            if (templates.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                        <h3 style="font-size: 18px; color: var(--text-primary); margin-bottom: 8px;">Ï†ÄÏû•Îêú ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏäµÎãàÎã§</h3>
                        <p>ÏûêÏ£º ÏÇ¨Ïö©ÌïòÎäî ÏùºÏ†ïÏùÑ ÌÖúÌîåÎ¶øÏúºÎ°ú Ï†ÄÏû•Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>
                `;
            } else {
                html += '<div class="subject-list">';
                templates.forEach((template, index) => {
                    const createdDate = new Date(template.createdAt);
                    const dateStr = `${createdDate.getMonth() + 1}/${createdDate.getDate()}`;
                    const teamCount = template.data.teams.length;
                    let scheduleCount = 0;
                    template.data.teams.forEach(team => {
                        scheduleCount += (template.data.teamSchedules[team] || []).length;
                    });
                    
                    html += `
                        <div class="subject-item" style="background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h4 style="font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">${template.name}</h4>
                                    <div style="display: flex; gap: 15px; font-size: 14px; color: var(--text-secondary);">
                                        <span>üë• ${teamCount}Í∞ú Ï°∞</span>
                                        <span>üìÖ ${scheduleCount}Í∞ú ÏùºÏ†ï</span>
                                        <span>üïê ${dateStr} ÏÉùÏÑ±</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button 
                                    onclick="applyTemplate(${index})"
                                    style="flex: 1; background: #ec4899; color: white; border: none; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                    ‚úÖ Ï†ÅÏö©ÌïòÍ∏∞
                                </button>
                                <button 
                                    onclick="deleteTemplate(${index})"
                                    style="background: #ef4444; color: white; border: none; padding: 12px 16px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                    üóëÔ∏è ÏÇ≠Ï†ú
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderDashboard() {
            const container = document.getElementById('dashboardContent');
            if (!container) return;
            
            // 1. Ï†ÑÏ≤¥ ÏùºÏ†ï Í∞úÏàò
            const totalSchedules = Object.keys(scheduleData).length;
            
            // 2. ÏãúÌóò Í∞úÏàòÏôÄ Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÏãúÌóò
            const examList = Object.keys(examDates).sort();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            const upcomingExams = examList.filter(d => d >= todayStr);
            let nextExamInfo = '';
            if (upcomingExams.length > 0) {
                const nextExamDate = upcomingExams[0];
                const nextExam = new Date(nextExamDate);
                const nextExamType = examDates[nextExamDate];
                const daysUntil = Math.ceil((nextExam - today) / (1000 * 60 * 60 * 24));
                nextExamInfo = `<span style="color: #dc2626; font-weight: 700; font-size: 24px;">D-${daysUntil}</span><br>${nextExam.getMonth() + 1}Ïõî ${nextExam.getDate()}Ïùº<br><span style="font-size: 14px; color: var(--text-secondary);">${nextExamType.icon} ${nextExamType.label}</span>`;
            } else {
                nextExamInfo = '<span style="color: var(--text-secondary);">ÏòàÏ†ïÎêú ÌèâÍ∞Ä ÏóÜÏùå</span>';
            }
            
            // 3. Í≥ºÎ≥Ñ Î°úÌÖåÏù¥ÏÖò Í∏∞Í∞Ñ
            const subjectsSorted = subjects.sort((a, b) => a.startDate.localeCompare(b.startDate));
            
            // 4. Ïù¥Î≤à Îã¨ ÏùºÏ†ï ÌÜµÍ≥Ñ
            const currentMonthSchedules = Object.keys(scheduleData).filter(date => {
                return date.startsWith(`${currentYear}-${String(currentMonth).padStart(2, '0')}`);
            });
            
            // 5. Ï†ÑÏ≤¥ ÏßÑÌñâÎ•† (3Ïõî~12Ïõî)
            const totalDays = 275; // 3Ïõî~12Ïõî ÎåÄÎûµ 275Ïùº
            const today2 = new Date();
            const marchFirst = new Date(2026, 2, 1); // 2026ÎÖÑ 3Ïõî 1Ïùº
            const daysPassed = Math.max(0, Math.ceil((today2 - marchFirst) / (1000 * 60 * 60 * 24)));
            const progress = Math.min(100, Math.round((daysPassed / totalDays) * 100));
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Ïπ¥Îìú 1: Îì±Î°ùÎêú ÏùºÏ†ï -->
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 5px solid #3b82f6; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 8px;">üìÖ Îì±Î°ùÎêú ÏùºÏ†ï</div>
                        <div style="font-size: 32px; font-weight: 700; color: #1e3a8a;">${totalSchedules}Í∞ú</div>
                        <div style="font-size: 12px; color: #3b82f6; margin-top: 5px;">Ïù¥Î≤à Îã¨: ${currentMonthSchedules.length}Í∞ú</div>
                    </div>
                    
                    <!-- Ïπ¥Îìú 2: Îã§Ïùå ÏãúÌóò -->
                    <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 5px solid #ef4444; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 14px; color: #991b1b; font-weight: 600; margin-bottom: 8px;">‚≠ê Îã§Ïùå ÏãúÌóò</div>
                        <div style="font-size: 20px; font-weight: 700; color: #7f1d1d;">${nextExamInfo}</div>
                        <div style="font-size: 12px; color: #dc2626; margin-top: 5px;">Ï†ÑÏ≤¥ ${examList.length}Í∞ú</div>
                    </div>
                    
                    <!-- Ïπ¥Îìú 3: Í≥º Í∞úÏàò -->
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-left: 5px solid #22c55e; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 14px; color: #15803d; font-weight: 600; margin-bottom: 8px;">üìö Îì±Î°ùÎêú Í≥º</div>
                        <div style="font-size: 32px; font-weight: 700; color: #14532d;">${subjects.length}Í∞ú</div>
                        <div style="font-size: 12px; color: #22c55e; margin-top: 5px;">Î°úÌÖåÏù¥ÏÖò Í≥ºÎ™©</div>
                    </div>
                    
                    <!-- Ïπ¥Îìú 4: ÏßÑÌñâÎ•† -->
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 5px solid #f59e0b; padding: 20px; border-radius: 12px;">
                        <div style="font-size: 14px; color: #92400e; font-weight: 600; margin-bottom: 8px;">üìà Ï†ÑÏ≤¥ ÏßÑÌñâÎ•†</div>
                        <div style="font-size: 32px; font-weight: 700; color: #78350f;">${progress}%</div>
                        <div style="font-size: 12px; color: #d97706; margin-top: 5px;">3Ïõî~12Ïõî Í∏∞Ï§Ä</div>
                    </div>
                </div>
                
                <!-- Í≥ºÎ≥Ñ Î°úÌÖåÏù¥ÏÖò Í∏∞Í∞Ñ -->
                <div style="background: white; border: 2px solid var(--border); border-radius: 16px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 20px;">üìö Í≥ºÎ≥Ñ Î°úÌÖåÏù¥ÏÖò Í∏∞Í∞Ñ</h3>
            `;
            
            if (subjects.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Îì±Î°ùÎêú Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
            } else {
                html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
                subjectsSorted.forEach(subject => {
                    const startDate = subject.startDate ? new Date(subject.startDate) : null;
                    const endDate = subject.endDate ? new Date(subject.endDate) : null;
                    
                    let dateDisplay = 'Í∏∞Í∞Ñ ÎØ∏Ï†ï';
                    let daysCount = 0;
                    
                    if (startDate && endDate) {
                        const start = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
                        const end = `${endDate.getMonth() + 1}/${endDate.getDate()}`;
                        daysCount = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        dateDisplay = `${start} ~ ${end} (${daysCount}Ïùº)`;
                    }
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-main); border-radius: 10px; border-left: 4px solid ${subject.color};">
                            <div style="width: 20px; height: 20px; background: ${subject.color}; border-radius: 4px;"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 16px; color: var(--text-primary); margin-bottom: 3px;">${subject.name || 'Ïù¥Î¶Ñ ÏóÜÏùå'}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">${dateDisplay}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `
                </div>
                
                <!-- ÌèâÍ∞Ä ÏùºÏ†ï -->
                <div style="background: white; border: 2px solid var(--border); border-radius: 16px; padding: 25px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 20px;">‚≠ê ÌèâÍ∞Ä ÏùºÏ†ï</h3>
            `;
            
            if (examList.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Îì±Î°ùÎêú ÌèâÍ∞ÄÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
            } else {
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                examList.forEach(dateStr => {
                    const examDate = new Date(dateStr);
                    const examInfo = examDates[dateStr];
                    const dayOfWeek = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][examDate.getDay()];
                    const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
                    const isPast = dateStr < todayStr;
                    const isToday = dateStr === todayStr;
                    
                    let badge = '';
                    if (isToday) {
                        badge = '<span style="background: #dc2626; color: white; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 700;">Ïò§Îäò</span>';
                    } else if (!isPast) {
                        badge = `<span style="background: #fbbf24; color: #78350f; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 700;">D-${daysUntil}</span>`;
                    } else {
                        badge = '<span style="background: #d1d5db; color: #6b7280; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 700;">Ï¢ÖÎ£å</span>';
                    }
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${isPast ? '#f9fafb' : examInfo.color + '20'}; border-radius: 8px; border-left: 4px solid ${examInfo.color}; ${isPast ? 'opacity: 0.6;' : ''}">
                            <div style="font-size: 24px;">${examInfo.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 15px; color: var(--text-primary);">${examDate.getMonth() + 1}Ïõî ${examDate.getDate()}Ïùº (${dayOfWeek})</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${examInfo.label}</div>
                            </div>
                            ${badge}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function getWeekDates(dateStr) {
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay(); // 0=Ïùº, 1=Ïõî, ..., 6=ÌÜ†
            
            // ÏõîÏöîÏùº Ï∞æÍ∏∞ (dayOfWeek === 1)
            const monday = new Date(date);
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // ÏùºÏöîÏùºÏù¥Î©¥ ÏßÄÎÇúÏ£º ÏõîÏöîÏùº
            monday.setDate(date.getDate() + diff);
            
            // Ïõî~Í∏à ÎÇ†Ïßú Î∞∞Ïó¥ ÏÉùÏÑ±
            const weekDates = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                weekDates.push(d);
            }
            
            return weekDates;
        }
        
        function renderWeeklyTimetable() {
            const container = document.getElementById('weeklyContent');
            if (!container || !selectedDate) return;
            
            const weekDates = getWeekDates(selectedDate);
            const dayNames = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à'];
            
            // Ï£ºÏ∞® Ï†ïÎ≥¥
            const firstDate = weekDates[0];
            const lastDate = weekDates[4];
            const weekTitle = `${firstDate.getMonth() + 1}Ïõî ${firstDate.getDate()}Ïùº ~ ${lastDate.getMonth() + 1}Ïõî ${lastDate.getDate()}Ïùº`;
            
            // ÏãúÍ∞ÑÎåÄ ÏÑ§Ï†ï (09:00 ~ 17:00, 1ÏãúÍ∞Ñ Îã®ÏúÑ)
            const timeSlots = [];
            for (let hour = 9; hour <= 17; hour++) {
                timeSlots.push(`${String(hour).padStart(2, '0')}:00`);
            }
            
            let html = `
                <div style="margin-bottom: 20px; text-align: center;">
                    <h3 style="font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">Ï£ºÍ∞Ñ ÏãúÍ∞ÑÌëú</h3>
                    <p style="color: var(--text-secondary); font-size: 16px;">${weekTitle}</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 800px; background: white; box-shadow: 0 2px 8px var(--shadow);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                                <th style="border: 2px solid #e5e7eb; padding: 15px 10px; font-size: 15px; font-weight: 700; width: 100px;">ÏãúÍ∞Ñ</th>
            `;
            
            // ÏöîÏùº Ìó§Îçî
            weekDates.forEach((date, index) => {
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                html += `<th style="border: 2px solid #e5e7eb; padding: 15px 10px; font-size: 15px; font-weight: 700;">${dayNames[index]}<br><span style="font-size: 13px; font-weight: 400;">(${dateStr})</span></th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            // ÏãúÍ∞ÑÎåÄÎ≥Ñ Ìñâ
            timeSlots.forEach(timeSlot => {
                html += `<tr>`;
                html += `<td style="border: 2px solid #e5e7eb; padding: 12px 8px; font-weight: 600; font-size: 14px; text-align: center; background: #f9fafb; font-family: 'JetBrains Mono', monospace;">${timeSlot}</td>`;
                
                // Í∞Å ÏöîÏùºÎ≥Ñ ÏÖÄ
                weekDates.forEach(date => {
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const dayData = scheduleData[dateStr];
                    
                    let cellContent = '';
                    
                    if (dayData && dayData.teams) {
                        // Ïù¥ ÏãúÍ∞ÑÎåÄÏóê Ìï¥ÎãπÌïòÎäî ÏùºÏ†ï Ï∞æÍ∏∞
                        dayData.teams.forEach(team => {
                            const schedules = dayData.teamSchedules[team] || [];
                            schedules.forEach(item => {
                                const startTime = item.startTime || item.time || '';
                                const endTime = item.endTime || '';
                                
                                // ÏãúÍ∞ÑÏù¥ Ïù¥ Ïä¨Î°ØÏóê Ìï¥ÎãπÌïòÎäîÏßÄ ÌôïÏù∏
                                if (startTime && startTime.startsWith(timeSlot.substring(0, 2))) {
                                    const timeDisplay = endTime ? `${startTime}~${endTime}` : startTime;
                                    cellContent += `<div style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border-left: 4px solid #8b5cf6; padding: 8px; margin-bottom: 6px; border-radius: 6px; font-size: 13px;">`;
                                    cellContent += `<div style="font-weight: 700; color: #5b21b6; margin-bottom: 3px;">${team}</div>`;
                                    cellContent += `<div style="color: #6d28d9; font-size: 12px; margin-bottom: 2px;">${timeDisplay}</div>`;
                                    cellContent += `<div style="color: #4c1d95; font-size: 12px;">${item.location || ''}</div>`;
                                    cellContent += `</div>`;
                                }
                            });
                        });
                    }
                    
                    html += `<td style="border: 2px solid #e5e7eb; padding: 8px; vertical-align: top; min-height: 60px; background: ${cellContent ? '#faf5ff' : 'white'};">${cellContent || '<span style="color: #d1d5db;">-</span>'}</td>`;
                });
                
                html += `</tr>`;
            });
            
            html += `</tbody></table></div>`;
            
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; text-align: center;">
                    <p style="color: #92400e; font-size: 14px; margin: 0;">üí° Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ Ï∞çÏñ¥ÏÑú Îã®ÌÜ°Î∞©Ïóê Í≥µÏú†ÌïòÏÑ∏Ïöî!</p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function addMember(teamName) {
            if (!teamMembers[teamName]) {
                teamMembers[teamName] = [];
            }
            teamMembers[teamName].push({ name: '', phone: '' });
            saveData();
            renderMembersList();
        }
        
        function removeMember(teamName, index) {
            teamMembers[teamName].splice(index, 1);
            saveData();
            renderMembersList();
        }
        
        function updateMember(teamName, index, field, value) {
            teamMembers[teamName][index][field] = value;
            saveData();
        }
        
        function renderMembersList() {
            const container = document.getElementById('membersContent');
            if (!container) return;
            
            let html = '<div class="subject-list">';
            
            Object.keys(teamMembers).sort().forEach(teamName => {
                const members = teamMembers[teamName] || [];
                
                html += `
                    <div class="subject-item" style="background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: var(--primary); margin: 0;">${teamName}</h3>
                            <button class="add-schedule-btn" onclick="addMember('${teamName}')" style="padding: 8px 16px; font-size: 14px;">+ Ï°∞Ïõê Ï∂îÍ∞Ä</button>
                        </div>
                `;
                
                if (members.length === 0) {
                    html += '<p style="color: var(--text-secondary); font-size: 14px; padding: 10px 0;">Ï°∞ÏõêÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>';
                } else {
                    members.forEach((member, index) => {
                        html += `
                            <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input 
                                    type="text" 
                                    placeholder="Ïù¥Î¶Ñ" 
                                    value="${member.name}"
                                    onchange="updateMember('${teamName}', ${index}, 'name', this.value)"
                                    style="flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px;"
                                />
                                <input 
                                    type="tel" 
                                    placeholder="Ï†ÑÌôîÎ≤àÌò∏" 
                                    value="${member.phone}"
                                    onchange="updateMember('${teamName}', ${index}, 'phone', this.value)"
                                    style="flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px;"
                                />
                                <button 
                                    onclick="removeMember('${teamName}', ${index})"
                                    style="background: #ef4444; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">ÏÇ≠Ï†ú</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderSubjectList() {
            const container = document.getElementById('subjectList');
            
            if (!container) return;
            
            if (subjects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <h3 style="font-size: 18px; color: var(--text-primary); margin-bottom: 8px;">üìö Îì±Î°ùÎêú Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨ Í≥ºÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            subjects.forEach((subject, index) => {
                html += `
                    <div class="subject-item" style="background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; padding: 20px; transition: all 0.2s ease;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; flex-wrap: wrap;">
                            <div class="subject-color-picker" style="background: ${subject.color}; cursor: pointer;" onclick="toggleColorPicker(${index})"></div>
                            <input type="text" class="subject-input" placeholder="Í≥º Ïù¥Î¶Ñ ÏûÖÎ†• (Ïòà: ÏÇ∞Î∂ÄÏù∏Í≥º)" value="${subject.name}" onchange="updateSubject(${index}, 'name', this.value)" style="flex: 1; min-width: 150px; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px;" />
                            <button class="remove-subject-btn" onclick="removeSubject(${index})" style="background: #ef4444; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">üóëÔ∏è ÏÇ≠Ï†ú</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <input type="date" class="date-input" value="${subject.startDate}" onchange="updateSubject(${index}, 'startDate', this.value)" min="2026-03-01" max="2026-12-31" style="width: 140px; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px;" />
                            <span style="font-weight: 600; color: var(--text-secondary);">~</span>
                            <input type="date" class="date-input" value="${subject.endDate}" onchange="updateSubject(${index}, 'endDate', this.value)" min="2026-03-01" max="2026-12-31" style="width: 140px; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px;" />
                        </div>
                `;
                
                if (showingColorPicker === index) {
                    html += `
                        <div class="color-palette" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; margin-top: 12px;">
                            ${colorPalette.map(color => `
                                <div class="color-option ${subject.color === color ? 'selected' : ''}" 
                                     style="background: ${color}; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; border: 3px solid ${subject.color === color ? 'var(--text-primary)' : 'transparent'}; transition: all 0.2s ease;" 
                                     onclick="updateSubject(${index}, 'color', '${color}'); toggleColorPicker(${index});"></div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        function exportSchedule() {
            if (!selectedDate) return;
            const data = scheduleData[selectedDate];
            const dateObj = new Date(selectedDate);
            const dateStr = `${dateObj.getMonth() + 1}Ïõî ${dateObj.getDate()}Ïùº`;
            const dayOfWeek = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][dateObj.getDay()];
            const subject = getSubjectForDate(selectedDate);
            const examInfo = examDates[selectedDate];
            
            let message = `üìÖ ${dateStr}(${dayOfWeek}) Î°úÌÖåÏù¥ÏÖò ÏùºÏ†ï\n`;
            if (subject) message += `üìö ${subject.name}\n`;
            if (examInfo) message += `${examInfo.icon} ${examInfo.label}\n`;
            message += `${'='.repeat(40)}\n\n`;
            
            data.teams.forEach(team => {
                const schedules = data.teamSchedules[team];
                message += `„Äê ${team} „Äë\n`;
                
                // Ï°∞Ïõê Î™ÖÎã® Ï∂îÍ∞Ä
                if (teamMembers[team] && teamMembers[team].length > 0) {
                    const memberNames = teamMembers[team].map(m => m.name).filter(n => n).join(', ');
                    if (memberNames) {
                        message += `  Ï°∞Ïõê: ${memberNames}\n`;
                    }
                }
                
                // ÏùºÏ†ï Ï∂îÍ∞Ä
                if (schedules && schedules.length > 0) {
                    schedules.forEach(item => {
                        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ìò∏Ìôò (time)
                        const startTime = item.startTime || item.time;
                        const endTime = item.endTime;
                        
                        if (startTime && item.location) {
                            if (endTime) {
                                message += `  ${startTime} ~ ${endTime}  ‚Üí  ${item.location}\n`;
                            } else {
                                message += `  ${startTime}  ‚Üí  ${item.location}\n`;
                            }
                        }
                    });
                }
                message += `\n`;
            });
            
            if (data.notes.trim()) {
                message += `üìå Ï∞∏Í≥†ÏÇ¨Ìï≠\n${'-'.repeat(40)}\n${data.notes}\n`;
            }
            
            message += `\n${'='.repeat(40)}`;
            document.getElementById('exportMessage').textContent = message;
            document.getElementById('exportModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('exportModal').classList.remove('show');
        }
        
        function copyToClipboard() {
            const message = document.getElementById('exportMessage').textContent;
            navigator.clipboard.writeText(message).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Î≥µÏÇ¨ ÏôÑÎ£å!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        document.getElementById('exportModal').addEventListener('click', (e) => {
            if (e.target.id === 'exportModal') closeModal();
        });
        
        // Îç∞Ïù¥ÌÑ∞ Î≤ÑÏ†Ñ Ï≤¥ÌÅ¨ Î∞è ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
        const DATA_VERSION = '2.0';
        const savedVersion = localStorage.getItem('rotationDataVersion');
        
        if (savedVersion !== DATA_VERSION) {
            console.log('Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Î≥ÄÍ≤Ω Í∞êÏßÄ - Ï¥àÍ∏∞Ìôî Ï§ë...');
            localStorage.removeItem('rotationScheduleData');
            localStorage.removeItem('rotationSubjects');
            localStorage.removeItem('rotationExams');
            localStorage.setItem('rotationDataVersion', DATA_VERSION);
            alert('Ïï±Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!\nÍ∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ Ìò∏ÌôòÎêòÏßÄ ÏïäÏïÑ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // ÏïàÏ†ÑÌïú Ï¥àÍ∏∞Ìôî
        try {
            loadData();
            console.log('Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
        } catch (e) {
            console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
            alert('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ' + e.message);
        }
        
        try {
            initCalendar();
            console.log('Ï∫òÎ¶∞Îçî Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        } catch (e) {
            console.error('Ï∫òÎ¶∞Îçî Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', e);
            alert('Ï∫òÎ¶∞Îçî Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + e.message);
        }
        
        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.getElementById('subjectModal').addEventListener('click', (e) => {
            if (e.target.id === 'subjectModal') {
                closeSubjectModal();
            }
        });
        
        document.getElementById('membersModal').addEventListener('click', (e) => {
            if (e.target.id === 'membersModal') {
                closeMembersModal();
            }
        });
        
        document.getElementById('weeklyModal').addEventListener('click', (e) => {
            if (e.target.id === 'weeklyModal') {
                closeWeeklyView();
            }
        });
        
        document.getElementById('dashboardModal').addEventListener('click', (e) => {
            if (e.target.id === 'dashboardModal') {
                closeDashboard();
            }
        });
        
        document.getElementById('templateModal').addEventListener('click', (e) => {
            if (e.target.id === 'templateModal') {
                closeTemplateModal();
            }
        });
        
        document.getElementById('examTypeModal').addEventListener('click', (e) => {
            if (e.target.id === 'examTypeModal') {
                closeExamTypeModal();
            }
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>
